<script lang="ts">
    import type { Game } from '$lib/game';

    export let game: Game;

    function formatNumber(num: number): string {
        if (num >= 1_000_000_000_000) {
            return (num / 1_000_000_000_000).toFixed(2) + 'T';
        } else if (num >= 1_000_000_000) {
            return (num / 1_000_000_000).toFixed(2) + 'B';
        } else if (num >= 1_000_000) {
            return (num / 1_000_000).toFixed(2) + 'M';
        } else if (num >= 1_000) {
            return (num / 1_000).toFixed(2) + 'K';
        }
        return num.toFixed(2);
    }

    // Define all 6 RPG stats with their effects
    // TODO: These will eventually have independent levels and EXP
    interface StatDisplay {
        id: string;
        name: string;
        shortName: string;
        value: number;
        level: number; // Placeholder - will be independent stat level
        effect: string;
        color: string;
        available: boolean;
    }

    $: rpgStats = [
        {
            id: 'strength',
            name: 'Strength',
            shortName: 'STR',
            value: game.stats.strength,
            level: 1, // TODO: Will come from independent stat system
            effect: 'Attack',
            color: 'var(--red)',
            available: game.level >= 3
        },
        {
            id: 'agility',
            name: 'Agility',
            shortName: 'AGI',
            value: game.stats.dexterity, // Currently using dexterity, will be separate
            level: 1,
            effect: 'Attack Speed',
            color: 'var(--green)',
            available: game.level >= 3
        },
        {
            id: 'willpower',
            name: 'Willpower',
            shortName: 'WIL',
            value: 0, // TODO: New stat, not implemented yet
            level: 1,
            effect: 'Defense',
            color: 'var(--blue)',
            available: false // Will unlock later
        },
        {
            id: 'endurance',
            name: 'Endurance',
            shortName: 'END',
            value: 0, // TODO: New stat, not implemented yet
            level: 1,
            effect: 'HP',
            color: 'var(--yellow)',
            available: false // Will unlock later
        },
        {
            id: 'intelligence',
            name: 'Intelligence',
            shortName: 'INT',
            value: game.stats.intelligence,
            level: 1,
            effect: 'Mana',
            color: 'var(--blue)',
            available: game.level >= 3
        },
        {
            id: 'wisdom',
            name: 'Wisdom',
            shortName: 'WIS',
            value: game.stats.wisdom,
            level: 1,
            effect: 'Mana Regen',
            color: 'var(--yellow)',
            available: game.level >= 3
        }
    ] as StatDisplay[];
</script>

<div class="stats-view">
<div class="stats-container">
    <h2>Statistics</h2>

    <!-- Player Information - Compact single column -->
    <div class="info-section">
        <div class="info-row">
            <span class="info-label">Name:</span>
            <span class="info-value">{game.name}</span>
        </div>
        <div class="info-row highlight">
            <span class="info-label">Level:</span>
            <span class="info-value level">{game.level}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Current EXP:</span>
            <span class="info-value">{formatNumber(game.exp)}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Lifetime EXP:</span>
            <span class="info-value">{formatNumber(game.lifetimeExp)}</span>
        </div>
    </div>

    <!-- RPG Stats - 6 stats in single column -->
    {#if game.level >= 3}
        <div class="section-header">RPG Statistics</div>
        <div class="rpg-stats">
            {#each rpgStats as stat (stat.id)}
                <div class="stat-row" class:locked={!stat.available}>
                    <div class="stat-main">
                        <div class="stat-name-group">
                            <span class="stat-short" style="color: {stat.color}">{stat.shortName}</span>
                            <span class="stat-name">{stat.name}</span>
                            <span class="stat-effect">+{stat.effect}</span>
                        </div>
                        <div class="stat-values">
                            <span class="stat-level">Lv.{stat.level}</span>
                            <span class="stat-value" style="color: {stat.color}">{stat.value}</span>
                        </div>
                    </div>
                    <!-- TODO: Progress bar for stat EXP will go here -->
                    <div class="stat-progress-placeholder">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="progress-info">
                            {#if stat.available}
                                <span class="progress-text">0 / 100 EXP</span>
                                <span class="progress-cost">Cost: 0 EXP</span>
                            {:else}
                                <span class="progress-text locked-text">Locked</span>
                            {/if}
                        </div>
                    </div>
                </div>
            {/each}
        </div>
    {/if}

    <!-- Progress Rates - Derived stats -->
    <div class="section-header">Progress Rates</div>
    <div class="rates-section">
        <div class="rate-row">
            <span class="rate-label">Click Value:</span>
            <span class="rate-value">{formatNumber(game.getClickValue())} EXP</span>
        </div>
        {#if game.idleExpRate > 0}
            <div class="rate-row">
                <span class="rate-label">Idle EXP:</span>
                <span class="rate-value">{formatNumber(game.idleExpRate)}/s</span>
            </div>
        {/if}
        {#if game.level >= 3}
            <div class="rate-row">
                <span class="rate-label">Training Speed:</span>
                <span class="rate-value">{(game.getTrainingSpeedMultiplier() * 100).toFixed(0)}%</span>
            </div>
            <div class="rate-row">
                <span class="rate-label">Training Cost:</span>
                <span class="rate-value">{(game.getTrainingCostMultiplier() * 100).toFixed(0)}%</span>
            </div>
        {/if}
    </div>

    <!-- Upgrades Owned - Condensed -->
    <div class="section-header">Upgrades Owned ({Object.values(game.upgrades).filter(u => u.currentLevel > 0).length})</div>
    <div class="upgrades-section">
        {#each Object.values(game.upgrades).filter(u => u.currentLevel > 0) as upgrade}
            <div class="upgrade-row">
                <span class="upgrade-name">{upgrade.name}</span>
                <span class="upgrade-level">Lv.{upgrade.currentLevel}</span>
            </div>
        {/each}
        {#if Object.values(game.upgrades).filter(u => u.currentLevel > 0).length === 0}
            <div class="empty-message">No upgrades purchased yet</div>
        {/if}
    </div>
</div>
</div>

<style>
    .stats-view {
        height: 100%;
        width: 100%;
        background-color: var(--bg);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .stats-container {
        padding: 0.75rem;
        max-width: 700px;
        margin: 0 auto;
        font-family: 'JetBrains Mono', monospace;
    }

    h2 {
        color: var(--text);
        font-family: Lato, sans-serif;
        font-weight: 300;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    /* Section Headers */
    .section-header {
        color: var(--blue);
        font-family: Lato, sans-serif;
        font-weight: 400;
        font-size: 1.1rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid var(--text);
        opacity: 0.9;
    }

    /* Player Info Section - Compact rows */
    .info-section {
        background: var(--alt-bg);
        border: 1px solid var(--text);
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 1rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row.highlight {
        background: rgba(255, 255, 255, 0.05);
    }

    .info-label {
        color: var(--text);
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .info-value {
        color: var(--text);
        font-size: 0.9rem;
        font-weight: 700;
    }

    .info-value.level {
        color: var(--yellow);
        font-size: 1rem;
    }

    /* RPG Stats Section - Dense single column */
    .rpg-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .stat-row {
        background: var(--alt-bg);
        border: 1px solid var(--text);
        border-radius: 4px;
        padding: 0.5rem;
        transition: opacity 0.3s;
    }

    .stat-row.locked {
        opacity: 0.4;
        border-color: rgba(255, 255, 255, 0.3);
    }

    .stat-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.35rem;
    }

    .stat-name-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stat-short {
        font-weight: 700;
        font-size: 0.85rem;
        min-width: 2.5rem;
    }

    .stat-name {
        color: var(--text);
        font-size: 0.85rem;
        font-weight: 400;
    }

    .stat-effect {
        color: var(--text);
        font-size: 0.75rem;
        opacity: 0.6;
        font-style: italic;
    }

    .stat-values {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stat-level {
        color: var(--text);
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
    }

    /* Progress Bar Placeholder */
    .stat-progress-placeholder {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .progress-bar-container {
        height: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: var(--green);
        transition: width 0.3s ease;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
    }

    .progress-text {
        color: var(--text);
        opacity: 0.7;
    }

    .progress-text.locked-text {
        color: var(--red);
        opacity: 0.8;
    }

    .progress-cost {
        color: var(--blue);
        opacity: 0.8;
    }

    /* Rates Section - Compact rows */
    .rates-section {
        background: var(--alt-bg);
        border: 1px solid var(--text);
        border-radius: 4px;
        padding: 0.5rem;
    }

    .rate-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .rate-row:last-child {
        border-bottom: none;
    }

    .rate-label {
        color: var(--text);
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .rate-value {
        color: var(--green);
        font-size: 0.9rem;
        font-weight: 700;
    }

    /* Upgrades Section - Compact list */
    .upgrades-section {
        background: var(--alt-bg);
        border: 1px solid var(--text);
        border-radius: 4px;
        padding: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .upgrade-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .upgrade-row:last-child {
        border-bottom: none;
    }

    .upgrade-name {
        color: var(--text);
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .upgrade-level {
        color: var(--blue);
        font-size: 0.85rem;
        font-weight: 700;
    }

    .empty-message {
        color: var(--text);
        font-size: 0.85rem;
        opacity: 0.6;
        text-align: center;
        padding: 1rem;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .stats-container {
            padding: 0.5rem;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .section-header {
            font-size: 1rem;
            margin-top: 1rem;
        }

        .info-row,
        .rate-row,
        .upgrade-row {
            padding: 0.3rem 0.4rem;
        }

        .stat-row {
            padding: 0.4rem;
        }

        .stat-short {
            font-size: 0.8rem;
            min-width: 2.25rem;
        }

        .stat-name {
            font-size: 0.8rem;
        }

        .stat-effect {
            font-size: 0.7rem;
        }

        .stat-value {
            font-size: 1rem;
        }
    }
</style>
